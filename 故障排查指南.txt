================================================================================
🔧 FCPDExtractor 故障排查指南
================================================================================

【问题1】TypeError: process_text_file_for_filter() got an unexpected keyword 
         argument 'model_name'

❌ 原因：Jupyter Notebook 使用了旧版本的函数（没有 model_name 参数）

✅ 解决方法（按顺序尝试）：

方法1：重新运行 Cell 7（推荐）
  1. 找到 Cell 7（模型配置中心）
  2. 点击运行该单元格
  3. 等待看到 "✅ 函数已更新为最新版本" 提示
  4. 继续运行步骤4

方法2：运行 Cell 27（模块重载）
  1. 找到 Cell 27（在步骤5之前）
  2. 运行该单元格
  3. 等待看到 "✅ 模块已重载" 提示
  4. 继续运行步骤4

方法3：重启 Jupyter Kernel（最可靠）
  1. 点击菜单栏 Kernel → Restart Kernel
  2. 从头运行所有单元格（Cell 2, 5, 7, 然后步骤1-5）

================================================================================

【问题2】模型加载失败

❌ 错误信息：
  "❌ 严格模式加载失败: xxx.gguf @ 绝对路径 -> Model file does not exist"

✅ 解决方法：

1. 检查文件是否存在
   cd /Users/zhaowenyuan/Projects/FCPDExtractor/models
   ls -lh *.gguf

2. 确认文件名拼写正确（区分大小写！）
   - 错误：Meta-Llama-3.1-8B-Instruct-Q4_K_M.gguf
   - 正确：meta-llama-3.1-8b-instruct-q4_k_m-2.gguf

3. 检查文件完整性（确保下载完整）
   - 正常大小参考：
     nous-hermes: ~7GB
     gpt-oss-20b: ~12GB
     meta-llama: ~5GB

4. 如果文件不存在，下载正确的模型文件
   - 从 HuggingFace 或 gpt4all 官方下载
   - 放入 models/ 目录

================================================================================

【问题3】内存不足

❌ 错误信息：
  "llama_new_context_with_model: failed to initialize Metal backend"

✅ 解决方法：

1. 换用更小的模型
   在 Cell 7 修改配置：
   
   MODEL_FILTER = 'nous-hermes-llama2-13b.Q4_0.gguf'     # 7GB
   MODEL_ABSTRACT = 'mistral-7b-instruct-v0.1.Q4_0.gguf' # 4GB
   MODEL_SUMMARIZE = 'mistral-7b-instruct-v0.1.Q4_0.gguf' # 4GB

2. 减少处理的段落数
   TOP_N_PARAGRAPHS = 5  # 从10改为5

3. 关闭其他占用内存的应用
   - 关闭浏览器多余标签页
   - 关闭其他 Python 程序
   - 释放系统内存

4. 设置内存限制环境变量（在 Cell 7 中添加）
   import os
   os.environ["FCPD_N_CTX"] = "2048"      # 上下文窗口
   os.environ["FCPD_N_BATCH"] = "128"     # 批处理大小

================================================================================

【问题4】配置修改不生效

❌ 症状：修改了 Cell 7 的配置，但运行时仍使用旧模型

✅ 解决方法：

1. 确保运行了 Cell 7
   - 单元格左侧应该显示执行序号 [数字]
   - 应该看到配置确认输出

2. 检查是否看到模块重载提示
   应该看到：
   "✅ Unified_Text_Processor 模块已重载"
   "✅ 函数已更新为最新版本"

3. 如果没有看到重载提示
   - 重启 Kernel
   - 重新运行 Cell 2, 5, 7

================================================================================

【问题5】步骤运行顺序错误

❌ 症状：跳过某些步骤导致变量未定义

✅ 正确的运行顺序：

必须按顺序运行：
  Cell 2  → 导入模块
  Cell 5  → 配置文件路径
  Cell 7  → 模型配置（会自动重载模块）
  Cell 9  → 步骤1：PDF转文本
  Cell 13 → 步骤2：文本预处理
  Cell 20 → 步骤3：嵌入相似度
  Cell 24 → 步骤4：LLM内容过滤
  Cell 29 → 步骤5：抽象和总结

可选：
  Cell 27 → 手动重载模块（如果步骤4报错时运行）

================================================================================

【问题6】找不到中间文件

❌ 错误信息：
  "FileNotFoundError: [Errno 2] No such file or directory: '..._Filtered.txt'"

✅ 解决方法：

1. 检查上一步是否成功完成
   - 步骤3必须完成才能运行步骤4
   - 步骤4必须完成才能运行步骤5

2. 查看输出目录
   ls -lh Data/output/101021acsoprd7b00291/

3. 如果文件被删除了，重新运行之前的步骤

4. 注意：中间文件在步骤5完成后会被自动删除
   - 保留的文件：_Summarized.txt 和 _Overall.txt
   - 删除的文件：_Filtered.txt, _Abstract.txt 等

================================================================================

【问题7】Jupyter Kernel 死掉

❌ 症状：单元格一直显示 [*]，长时间无响应

✅ 解决方法：

1. 等待（大模型可能需要较长时间）
   - 步骤4：~1-5分钟
   - 步骤5：~5-15分钟（取决于模型大小）

2. 如果真的卡住了
   - 点击菜单栏 Kernel → Interrupt
   - 等待几秒
   - 重新运行该单元格

3. 如果无法恢复
   - Kernel → Restart Kernel
   - 从 Cell 2 重新开始

================================================================================

【快速诊断】

运行以下命令检查环境：

# 1. 检查模型文件
ls -lh /Users/zhaowenyuan/Projects/FCPDExtractor/models/*.gguf

# 2. 检查输出目录
ls -lh /Users/zhaowenyuan/Projects/FCPDExtractor/Data/output/*/

# 3. 检查 Python 模块
cd /Users/zhaowenyuan/Projects/FCPDExtractor
python3 -c "import sys; sys.path.append('Text Extraction'); \
from Unified_Text_Processor import process_text_file_for_filter; \
import inspect; print(inspect.signature(process_text_file_for_filter))"

预期输出应包含：(file_path, model_name='...')

================================================================================

【获取帮助】

如果以上方法都无法解决问题，请提供以下信息：

1. 完整的错误信息（包括 Traceback）
2. 正在运行的 Cell 序号
3. Cell 7 的配置内容
4. models/ 目录下的文件列表
5. 系统内存使用情况

参考文档：
- 详细使用指南：模型配置使用指南.txt
- 快速参考：快速参考.txt
- 英文文档：MODEL_CONFIG_GUIDE.md

================================================================================

